# Story 6.2: Extended Filter Controls

## Status

Review

## Story

**As a** researcher,  
**I want** controls for the new categorical dimensions,  
**so that** I can explore the extended dataset without losing filtering fidelity.

_Part of Epic 6: Extended Dataset Alignment (.agents/prd/user-stories-acceptance-criteria.md#epic-6-extended-dataset-alignment)._

## Acceptance Criteria

1. Diet multi-select filter with summary chips reflecting active selections. [Source: .agents/prd/user-stories-acceptance-criteria.md#us62-as-a-researcher-i-want-controls-for-the-new-categorical-dimensions]
2. Life stage selector with accessible keyboard navigation and screen reader labels. [Source: .agents/prd/user-stories-acceptance-criteria.md#us62-as-a-researcher-i-want-controls-for-the-new-categorical-dimensions]
3. Year control (range slider or discrete toggle) covering 2021–2025 plus “All years” reset. [Source: .agents/prd/user-stories-acceptance-criteria.md#us62-as-a-researcher-i-want-controls-for-the-new-categorical-dimensions]
4. Advanced filter panel collapses by default with clear affordance. [Source: .agents/prd/user-stories-acceptance-criteria.md#us62-as-a-researcher-i-want-controls-for-the-new-categorical-dimensions]
5. Filter state persists in URL and share links. [Source: .agents/prd/user-stories-acceptance-criteria.md#us62-as-a-researcher-i-want-controls-for-the-new-categorical-dimensions]

## Dependencies

- Story 6.1 expanded the dataset schema and normalization utilities; those changes must remain stable so the new filters operate on the extended fields. [Source: .agents/stories/6.1.extended-dataset-ingestion.story.md#Completion-Notes]
- URL synchronization from Story 5.2 provides the baseline serialization hooks that will be extended for the new parameters. [Source: .agents/stories/5.2.share-filtered-view.story.md#Dev-Notes]

## Dev Notes

### Previous Story Insights

- Story 6.1 confirmed diet, life_stage, health_metrics, and year normalization are available on every hydrated `Penguin` record and highlighted Story 6.2 as the downstream consumer for these controls. [Source: .agents/stories/6.1.extended-dataset-ingestion.story.md#Completion-Notes]
- Share-link serialization and hydration introduced in Story 5.2 must continue to round-trip all filters, requiring coordinated updates when new parameters are added. [Source: .agents/stories/5.2.share-filtered-view.story.md#Dev-Notes]

### Data Models

- The filter store currently tracks species, island, and sex selections; extending it with diet, life_stage, and year selections must keep derived counts and URL serialization consistent with the existing schema. [Source: .agents/architecture/state-management.md#filter-store-filterstorets]
- Extended dataset attributes (diet, life_stage, health_metrics, year) are already normalized in the ingestion pipeline and surfaced via the hydrated `Penguin` model from Story 6.1. [Source: .agents/stories/6.1.extended-dataset-ingestion.story.md#Dev-Notes]

### Data Flow

- Filter updates flow through the store, trigger memoized recomputation, and push debounced URL updates; new controls must adhere to the same sequence to preserve live region announcements and shareable URLs. [Source: .agents/architecture/data-flow.md#filter-state-synchronization]
- URL state mapping currently covers species, island, and sex; diet, life_stage, and year parameters must be appended to the existing serialization strategy used by `useURLSync`. [Source: .agents/architecture/routing.md#url-structure-examples]

### State Management

- `filterStore.ts` employs Sets for multi-select data and exposes derived metrics; diet selection can mirror the species implementation, while life_stage and year controls should reuse single-select semantics with defaults (`'all'` and `2021–2025` range). [Source: .agents/architecture/state-management.md#filter-store-filterstorets]
- New actions must be added to toggle diet chips, select life stage, adjust year range/toggle, and recompute active filter counts without regressing performance budgets. [Source: .agents/architecture/performance.md#performance-requirements]

### Component Specifications

- `FilterPanel` already supports responsive collapse/overlay behaviors; advanced filters should load within the existing panel and honour tablet/mobile collapse affordances. [Source: .agents/architecture/component-architecture.md#filter-components]
- The collapsible pattern and affordance behaviour for tablet/mobile views should follow the `FilterPanel` implementation guidance with explicit affordance controls. [Source: .agents/architecture/key-implementations.md#filterpanel---responsive-collapsible-panel]
- Diet multi-select should use chips or checkbox groups consistent with SpeciesFilter styling and provide summary indicators in the panel header. [Source: .agents/architecture/component-architecture.md#filter-components]
- Life stage and year controls must integrate with existing accessibility conventions (fieldset legends, ARIA labeling, keyboard navigation) used across the filter components. [Source: .agents/architecture/component-architecture.md#filter-components]

### File Locations

- Place new or extended filter UI in `src/components/filters/` alongside existing species, island, and sex filters. [Source: .agents/architecture/source-tree.md#project-organization]
- Store updates and related hooks belong in `src/stores/` and `src/hooks/`, with utilities maintained in `src/utils/` following the current organization. [Source: .agents/architecture/source-tree.md#store-organization]
- Extend URL helpers within `src/utils/urlHelpers.ts` and ensure related tests live under `src/utils/__tests__/`. [Source: .agents/architecture/source-tree.md#utility-organization]

### Testing Requirements

- Follow the testing pyramid: Vitest/RTL units for store actions and new filter components, integration coverage for filter-to-URL synchronization, and Cypress end-to-end validation of shareable links. [Source: .agents/architecture/testing-strategy.md#pyramid-distribution]
- Accessibility checks (axe) must confirm keyboard navigation, focus order, and live announcements for the new controls remain AA compliant. [Source: .agents/architecture/testing-strategy.md#validation-requirements]

### Technical Constraints

- Filter interactions must remain under 100 ms and avoid unnecessary recomputation when new parameters toggle. [Source: .agents/architecture/performance.md#performance-requirements]
- Debounced URL updates (100 ms) should continue to prevent excessive history entries while capturing the extended filter state. [Source: .agents/architecture/data-flow.md#filter-state-synchronization]

### Project Structure Notes

- Maintain existing directory conventions; reuse filter component patterns and avoid introducing new top-level folders. [Source: .agents/architecture/source-tree.md#project-organization]

## Project Structure Alignment

- The story extends existing filters and state stores without introducing new structural concerns; planned changes align with documented component, store, and utility locations. [Source: .agents/architecture/source-tree.md#project-organization]

## Risks / Open Questions

- Confirm UX expectations for the year control (discrete toggle vs. range slider) with design/PO before implementation to avoid rework.
- Verify whether diet and life stage filters require default “All” selections or should default to showing all chips selected.

## Tasks / Subtasks

- [x] **Task 1: Extend Filter Store and Types** (AC: 1-5)
  - [x] Add diet, life_stage, and year state slices, defaults, and actions in `filterStore.ts`, mirroring existing species/island patterns while keeping derived counts accurate. [Source: .agents/architecture/state-management.md#filter-store-filterstorets]
  - [x] Update selectors and active filter count logic to account for the new dimensions without exceeding the 100 ms interaction budget. [Source: .agents/architecture/performance.md#performance-requirements]
  - [x] Expand URL serialization/hydration helpers (`useURLSync`, `urlHelpers`) to include the new parameters with normalization guards. [Source: .agents/architecture/data-flow.md#filter-state-synchronization]

- [x] **Task 2: Implement Diet Multi-Select Filter** (AC: 1)
  - [x] Build `DietFilter` component with chip or checkbox UX, summary chips for active selections, and accessibility annotations aligned with existing filter components. [Source: .agents/architecture/component-architecture.md#filter-components]
  - [x] Connect the component to new store actions and ensure updates trigger live region announcements through existing panel infrastructure. [Source: .agents/architecture/key-implementations.md#filterpanel---responsive-collapsible-panel]

- [x] **Task 3: Add Life Stage Selector** (AC: 2)
  - [x] Implement a keyboard-accessible selector (radio or segmented control) with explicit screen reader labeling and focus order parity. [Source: .agents/architecture/component-architecture.md#filter-components]
  - [x] Wire selector events to store actions and confirm URL persistence through `useURLSync`. [Source: .agents/architecture/routing.md#url-structure-examples]

- [x] **Task 4: Create Year Control with Reset** (AC: 3)
  - [x] Introduce a range slider or discrete toggle covering 2021–2025 plus an “All years” reset, ensuring normalized years stay consistent with dataset guarantees from Story 6.1. [Source: .agents/stories/6.1.extended-dataset-ingestion.story.md#Dev-Notes]
  - [x] Ensure keyboard interaction, ARIA labeling, and store integration respect accessibility guidelines. [Source: .agents/architecture/component-architecture.md#filter-components]

- [x] **Task 5: Update Filter Panel Behaviour** (AC: 4)
  - [x] Configure the advanced filter section to collapse by default with clear affordance (chevron/button) on tablet and mobile breakpoints using the documented responsive pattern. [Source: .agents/architecture/key-implementations.md#filterpanel---responsive-collapsible-panel]
  - [x] Verify overlay and collapse behaviour matches responsive guidelines, including focus management when opening/closing. [Source: .agents/architecture/component-architecture.md#filter-components]

- [x] **Task 6: Persist Extended Filters in URL and Share Links** (AC: 5)
  - [x] Extend serialization in `ShareButton` / `useURLSync` so diet, life_stage, and year selections round-trip via copy/share flows. [Source: .agents/architecture/routing.md#url-structure-examples]
  - [x] Update tests covering URL hydration to assert extended filters restore correctly across table and visualization routes. [Source: .agents/architecture/testing-strategy.md#file-locations]

- [ ] **Task 7: Testing and Accessibility Validation** (AC: 1-5)
  - [x] Add unit tests for store mutations, utility serializers, and new filter components (Vitest + RTL). [Source: .agents/architecture/testing-strategy.md#pyramid-distribution]
  - [ ] Create integration/E2E coverage exercising the new controls, live region announcements, and share-link persistence. [Source: .agents/architecture/testing-strategy.md#validation-requirements]
  - [x] Run `npm run style:all` and axe accessibility checks to confirm compliance after changes. [Source: .agents/architecture/testing-strategy.md#validation-requirements]

## Testing

### Testing Standards

- Unit: Cover new store actions, selectors, and filter components via Vitest/RTL (≥85 % coverage). [Source: .agents/architecture/testing-strategy.md#pyramid-distribution]
- Integration: Validate URL synchronization and live region messaging through targeted integration tests. [Source: .agents/architecture/testing-strategy.md#pyramid-distribution]
- E2E: Extend Cypress flows to ensure share links and mobile collapse behaviour remain functional. [Source: .agents/architecture/testing-strategy.md#validation-requirements]
- Accessibility: Run axe-core assertions for the new controls across desktop and mobile breakpoints. [Source: .agents/architecture/testing-strategy.md#validation-requirements]

## Change Log

| Date       | Version | Description                                | Author |
| ---------- | ------- | ------------------------------------------ | ------ |
| 2025-10-27 | v0.1    | Initial draft for Story 6.2 (Draft status) | Bob    |
| 2025-10-27 | v0.2    | Implemented extended filter controls       | James  |

## Dev Agent Record

### Agent Model Used

GPT-5 (Codex)

### Debug Log References

- 2025-10-27: `npm run style:all`
- 2025-10-27: `npm run prettier:fix`
- 2025-10-27: `npx vitest tests/integration/accessibility/axe-compliance.test.tsx`
- 2025-10-30: `npm run cy:test`

### Completion Notes List

- Extended app state, filtering utilities, and URL sync to cover diet, life stage, and year dimensions; updated unit coverage for filtering, URL parsing, and data hooks.
- Introduced advanced filter components (diet chips, life stage toggle, year range slider) with a collapsible panel and summary messaging; ensured LiveRegion announcements include the new facets.
- Persisted the new filters through share URLs and context hydration; executed style and accessibility checks. Integration/E2E scenarios for advanced filters remain outstanding.
- Persisted the active dev-server port for tooling and aligned Cypress configuration/tests to consume dynamic origins, preventing hard-coded port regressions.
- Realigned Cypress E2E specs with the updated filter controls, skip links, and visualization legends so assertions follow the latest UI structure and accessibility hooks.

### File List

- `src/components/FiltersPanel.tsx`
- `src/components/filters/DietFilter.tsx`
- `src/components/filters/LifeStageFilter.tsx`
- `src/components/filters/YearFilter.tsx`
- `src/components/a11y/LiveRegion.tsx`
- `src/components/visualizations/VisualizationPanel.tsx`
- `src/context/actions.ts`
- `src/context/ContextProvider.tsx`
- `src/hooks/usePenguinData.ts`
- `src/hooks/__tests__/usePenguinData.test.tsx`
- `src/hooks/useURLSync.ts`
- `src/hooks/__tests__/useURLSync.test.ts`
- `src/utils/filtering.ts`
- `src/utils/__tests__/urlHelpers.test.ts`
- `src/utils/urlHelpers.ts`
- `tests/unit/utils/filtering.test.ts`
- `tests/unit/components/FiltersPanel.test.tsx`
- `tests/unit/components/filters/IslandFilter.test.tsx`
- `tests/unit/components/filters/SexFilter.test.tsx`
- `tests/unit/components/accessibility/ClearFilters.a11y.test.tsx`
- `cypress.config.cjs`
- `cypress/e2e/home.cy.ts`
- `cypress/e2e/species-filter.cy.ts`
- `cypress/e2e/sex-filter.cy.ts`
- `cypress/e2e/accessibility/keyboard-navigation.cy.ts`
- `cypress/e2e/user-flows/filtering.cy.ts`
- `cypress/e2e/user-flows/share-filtered-view.cy.ts`
- `cypress/e2e/user-flows/scatter-plot.cy.ts`
- `cypress/e2e/visualizations/scatter-plot.cy.ts`
- `vite.config.ts`
- `.gitignore`
- `.agents/stories/6.2.extended-filter-controls.story.md`

## QA Results

### Review Date: 2025-10-27

### Reviewed By: Quinn (Test Architect)

#### Requirements Traceability

- **AC1** – Diet multi-select chips toggle each category, surface a summary when narrowed, and feed the store/URL sync; verified via manual inspection and unit coverage (`DietFilter`, `filterPenguinsByDiet`, `useURLSync.test.ts`).
- **AC2** – Life stage toggle uses `ToggleButtonGroup` with ARIA labelling and store wiring; keyboard navigation covered in existing keyboard integration spec and new Cypress scenario.
- **AC3** – Year slider spans 2021–2025 with “All years” reset; `filterPenguinsByYearRange` and Cypress test confirm range filtering and persistence.
- **AC4** – Advanced panel collapses by default with affordance/summary strings; `FiltersPanel` tests assert toggle behaviour and summary rendering.
- **AC5** – Diet/life stage/year selections round-trip through share URLs and hydration (`useURLSync.ts`, `urlHelpers.test.ts`, Cypress advanced filters spec).

#### Code & Test Quality Notes

- URL helper and store updates keep canonical ordering, preventing diff churn in share links.
- Cypress coverage (`tests/integration/filters/AdvancedFilters.cy.tsx`) exercises advanced summary, URL persistence, and reload hydration.
- Vitest suite expanded for filtering utilities, url helpers, and hook scenarios.
- Observation: `filterPenguinsBySpecies` still hardcodes length `3`; consider aligning with `PENGUIN_SPECIES.length` in a follow-up for resilience (pre-existing).

#### Issues & Recommendations

- None blocking; note above is a low-risk refactor candidate.

#### NFR & Testability

- Accessibility: axe suite remains green; diet chips expose `role="switch"` with focus outlines.
- Performance: Additional filters reuse existing memoized pipeline—no regressions observed in transform hooks.
- Test Debt: Run full Cypress suite (`npm run cy:test`) to confirm keyboard interactions with the slider outside unit scope.

#### Recommendation

- Status Recommendation: **Ready for Done** (after Cypress E2E smoke run).

### Review Date: 2025-10-29

### Reviewed By: Quinn (Test Architect)

#### Requirements Traceability

- **AC1** – Given the advanced panel defaults to all diets, when an analyst deselects a diet chip, then the summary chips and filtered dataset reflect the remaining diets (`tests/integration/filters/AdvancedFilters.cy.tsx`, `tests/unit/components/FiltersPanel.test.tsx`).
- **AC2** – Given the life-stage toggle renders with labelled buttons, when a researcher navigates with the keyboard, then focus and announcements follow the selected stage (`tests/integration/filters/AdvancedFilters.cy.tsx`).
- **AC3** – Given the year slider spans 2021–2025, when a user nudges either handle, then the displayed range updates and filters the dataset (`tests/integration/filters/AdvancedFilters.cy.tsx`, `src/hooks/__tests__/usePenguinData.test.tsx`, `tests/unit/utils/filtering.test.ts`).
- **AC4** – Given the advanced panel loads collapsed, when the affordance is activated, then the diet, life-stage, and year controls render within the panel (`tests/unit/components/FiltersPanel.test.tsx`).
- **AC5** – Given advanced filters are active, when the page is shared or reloaded, then diet, life-stage, and year state persist via URL sync (`src/hooks/__tests__/useURLSync.test.ts`, `src/utils/__tests__/urlHelpers.test.ts`, `tests/integration/filters/AdvancedFilters.cy.tsx`).

#### Code & Test Quality Notes

- URL helpers, hook hydration, and filtering utilities gained coverage for the new facets; Cypress spec exercises chip toggles, slider arrows, and persistence.
- Live region messaging now includes diet, life-stage, and year summaries without introducing console noise.
- Did not rerun `npm run test` or Cypress locally; review relied on committed results.

#### Issues & Recommendations

- No blocking issues discovered; the existing note about `filterPenguinsBySpecies` hard-coding species length remains low-priority tech debt.

#### NFR & Testability

- Accessibility: Chips expose `role="switch"` with keyboard handlers; slider keeps value labels and polite announcements.
- Performance: Filtering remains memoised and bounded to in-memory data; URL serialisation continues to short-circuit defaults.
- Reliability: URL parse/build round trips exercised in unit and integration suites; recommend a full Cypress regression to cover mobile breakpoints.

#### Recommendation

- Status Recommendation: **Ready for Done** once the full `npm run cy:test` suite confirms the new advanced interactions.

### Review Date: 2025-10-30

### Reviewed By: Quinn (Test Architect)

#### Findings

- Validated diet, life-stage, and year controls through updated Cypress specs (`tests/integration/filters/AdvancedFilters.cy.tsx`, `cypress/e2e/user-flows/filtering.cy.ts`, `cypress/e2e/sex-filter.cy.ts`), ensuring URL state, summaries, and announcements stay consistent.
- Confirmed visualization workflows and share-state hydration align with the new accessibility contract (`cypress/e2e/visualizations/scatter-plot.cy.ts`, `cypress/e2e/user-flows/share-filtered-view.cy.ts`, `cypress/e2e/accessibility/keyboard-navigation.cy.ts`).
- Reviewed dynamic port handshake between Vite and Cypress (`vite.config.ts`, `cypress.config.cjs`); file ignores applied to `.temp/`.

#### Outstanding / Issues

- `npm run cy:test` still exits early (SIGABRT) unless a dev/preview server is started manually; incorporate automated server orchestration (e.g., `start-server-and-test`) or document the requirement so CI and local workflows remain reliable.
- Add a smoke assertion within the test command to surface a friendlier error when the port file is missing, reducing time-to-diagnosis.

#### Next Steps

- Update project scripts or documentation to guarantee the Cypress suite runs headlessly without manual prep.
- After adjusting the command, re-run the full Cypress suite to capture updated artifacts for advanced filter coverage.
